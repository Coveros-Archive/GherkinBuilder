<!-- 
Improvements
 * Delete Data Row
 ** When Deleting Test Steps in Scenario Outlines, columns need to be auto-recalced
 * Re-order Data Row
 * Insert Tests
 * Insert Test Steps
 * Insert Data Row
 * Convert Scenario to Scenario Outline
 * Convert Scenario Outline to Scenario
 ** Data Table inherit Test Step input attributes
 * Keep Data Table columns in order with test steps
 ** Build this file (or js includes?) from python script using definitions
 ** Add tagging abilities
 -->
<html>
	<head>
		<title>Same Page</title>
		<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  		<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script>
			//our step functionality
			function step() {
				this.string = arguments[0];
				this.inputs = new Array();
				for (var i = 1; i < arguments.length; i++) {
					this.inputs.push( arguments[i] );
				}
			}
			//our keypair functionality
			function keypair( key, value ) {
				this.key = key;
				this.value = value;
			}
			//our basic setup
			var testSteps = new Object();
			testSteps.whens = new Array();
			testSteps.thens = new Array();
		</script>
		<script src='buildmember.js'></script>
		<script>console.log( testSteps );</script>
		<script>
			if (typeof String.prototype.startsWith != 'function') {
				String.prototype.startsWith = function (str){
					return this.slice(0, str.length) == str;
				};
			}
			if (typeof String.prototype.endsWith != 'function') {
				String.prototype.endsWith = function (str){
					return this.slice(-str.length) == str;
				};
			}
		</script>
		<script>
			function makeSortable() {
			    $( ".testSteps" ).sortable();
			    //$( ".testSteps" ).disableSelection();
			    $( "#tests" ).sortable({ handle: ".what" });
			    //$( "#tests" ).disableSelection();
			}
			function addScenario() {
				$('#tests').append( 
						"<div class='scenario'>" +
							"<div class='green'>" +
								"<span class='what'>Scenario:</span> <input class='green' placeholder='Scenario Title' type='text' />" + 
								"<br/>" +
								"<textarea placeholder='Scenario Description'></textarea>" +
							"</div>" +
							"<div class='testSteps'></div>\n" +
							"<button onclick='addTestStep(this)'>Add Test Step</button>" +
							"<div class='delete' onclick='del(this)'>&nbsp;</div>" +
						"</div>"
				);
				makeSortable();
			}
			function addScenarioOutline() {
				$('#tests').append( 
						"<div class='scenarioOutline'>" +
							"<div class='green'>" +
								"<span class='what'>Scenario Outline:</span> <input class='green' placeholder='Scenario Outline Title' type='text' />" + 
								"<br/>" +
								"<textarea placeholder='Scenario Outline Description'></textarea>" +
							"</div>" +
							"<div class='testSteps'></div>\n" +
							"<button onclick='addTestStep(this)'>Add Test Step</button>" +
							"<div class='delete' onclick='del(this)'>&nbsp;</div>" +
							"<div class='examples'>" +
								"<div class='green'>Examples:</div>" +
								"<table><thead><tr></tr></thead><tbody></tbody></table>" +
								"<button onclick='addDataRow(this)'>Add Data Row</button>" +
							"</div>" +
						"</div>"
				);
				makeSortable();
			}
			function addTestStep(el) {
				$(el).parent().find('.testSteps').append( 
						"<div class='testStep'><div class='edit' onclick='edit(this)'>&nbsp;</div><div class='delete' onclick='del(this)'>&nbsp;</div><select class='blue' onchange='fillStep(this)'><option></option><option>Given</option><option>When</option><option>Then</option></div>"
				);
			}
			function fillStep(el) {
				var value = $(el).val();
				$(el).nextAll().remove();
				var sel = $("<select></select>");
				var option = "<option />";
				if ( value == "Given" || value == "When" ) {
					for (i=0;i<testSteps.whens.length;i++) {
						option += '<option value="'+i+'">' + testSteps.whens[i].string + '</option>';
						$(sel).attr('onchange','fillVars(testSteps.whens,this)');
					}
				}
				else if ( value == "Then" ) {
					for (i=0;i<testSteps.thens.length;i++){
						option += '<option value="'+i+'">' + testSteps.thens[i].string + '</option>';
						$(sel).attr('onchange','fillVars(testSteps.thens,this)');
					}
				}
				else {
					return;
				}
				sel.append( option );
				$(el).after( sel );
			}
			function fillVars(step,el) {
				var stepList = $(el).val();
				var sClass = $(el).parent().parent().parent().attr("class");
				var testStepString = step[ stepList ].string;
				var testStepInputs = step[ stepList ].inputs;
				var testStepPieces = testStepString.split("XXXX") //.filter(function(el) {return el.length != 0});
				var type = $(el).prev()
				type.nextAll().remove();
				for ( i=0;i<testStepPieces.length;i++) {
					type.parent().append( "<span> " + testStepPieces[i] + "</span>" );
					if ( testStepInputs[i] !== undefined ) {
						if ( Object.prototype.toString.call( testStepInputs[i].value ) === '[object Array]' ) {
							var sel = $("<select></select>");
							if ( sClass == "scenarioOutline" ) {
								sel.attr('onchange','buildTable(this)');
								sel.append( "<option>&lt;"+testStepInputs[i].key+"&gt;</option>" );
							}
							for (j=0;j<testStepInputs[i].value.length;j++) {
								sel.append( "<option>" + testStepInputs[i].value[j] + "</option>" );
							}
							type.parent().append( sel );
						} else {
							if ( sClass == "scenarioOutline" ) {
								type.parent().append( "<input type='"+testStepInputs[i].value+"' onchange='buildTable(this)' placeholder='<"+testStepInputs[i].key+">' />" );								
							} else {
								type.parent().append( "<input type='"+testStepInputs[i].value+"' />" );
							}
						}
					}
				}
				if ( sClass == "scenarioOutline" ) {
					buildTable(type);
				}
				makeSortable();
			}
			function buildTable(el) {
				var variables = new Array();
				var scenario = $(el).parent().parent();
				scenario.children('.testStep').each(function(){
					$(this).children('input, select').each(function(){
						if ( $(this).val() == "" && $(this).is("input") ) {
							variables.push( $(this).attr('placeholder') );							
						}
						if ( $(this).val().startsWith("<") && $(this).val().endsWith(">") ) {
							variables.push( $(this).val() );
						}
					});
				});
				var examples = scenario.parent().children('.examples');
				var header = examples.children('table').children('thead').children('tr');
				var headerVals = new Array();
				header.children('th').each(function(){
					headerVals.push( $(this).html() );
					if ( $.inArray( "<"+$(this).html()+">", variables ) == -1 ) {
					    var column = $(this).parent().children().index(this);
					    examples.find('tr').each(function(){
					    	$(this).find("th:eq("+column+")").remove();
					    	$(this).find("td:eq("+column+")").remove();
					    })
					}
				});
				for ( i=0;i<variables.length;i++) {
					var headerVal = variables[i].substring(1,variables[i].length-1)
					if( $.inArray( headerVal, headerVals ) == -1 ) {
						header.append( "<th>" + headerVal + "</th>" );
						examples.children('table').children('tbody').children('tr').each(function(){
							$(this).append( "<td><input type='text' /></td>" );
						});
						
					}
				};
			}
			function addDataRow(el) {
				var examples = $(el).parent();
				var body = examples.children('table').children('tbody');
				var cols = examples.children('table').children('thead').children('tr').children('th');
				var row = $("<tr></tr>");
				cols.each(function(){
					row.append( "<td><input type='text' /></td>" );
				});
				body.append( row );
			}
			function del(el) {
				var r=confirm("Are you sure you want to delete this " + $(el).parent().attr('class') );
				if (r==true) {
					$(el).parent().remove();
//					buildTable($(el));
				}
			}
			function edit(el) {
				var r=confirm("Are you sure you want to edit this " + $(el).parent().attr('class') );
				if (r==true) {
					fillStep($(el).next().next());
				}
			}
			function download() {
				//build our data
				data = "Feature: " + $('#featuredef input').val() + "\n";
				data += $('#featuredef textarea').val() + "\n\n";
				$('.scenario, .scenarioOutline, .examples').each(function(){
					if ( $(this).attr('class') == "examples" ) {
						data += "Examples:\n";
						$(this).find('tr').each(function(){
							$(this).find('th').each(function(){
								data += "|\t"+$(this).html()+"\t";
							});
							$(this).find('input,select').each(function(){
								data += "|\t"+$(this).val()+"\t";
							});
							data += "|\n";
						});
					} else {
						data += "Scenario";
						if ( $(this).attr('class') == "scenarioOutline" ) {
							data += " Outline";
						}	
						data += ": " + $(this).find('.green input').val() + "\n";
						data += $(this).find('.green textarea').val() + "\n";
						$(this).find('.testStep').each(function(){
							$(this).children().each(function(){
								if ( $(this).val() == "" && $(this).is("input") ) {
									data += $(this).attr('placeholder');
								} else if ( $(this).is('select') || $(this).is('input') ) {
									data += $(this).val();
								} else {									
									data += $(this).html();
								}
							});
							data += "\n";
						});
					}
					data += "\n";
				});

				//fix extra spaces
				data = data.replace(/&nbsp;/g, ' ');
				data = data.replace(/( ){2,}/g, ' ');
				//download the file
				document.location = 'data:Application/octet-stream,' +
                encodeURIComponent( data );
				//warn the user about filename and linebreaks
				alert( "Note: this file will need to be renamed.\n\nOpen in wordpad or np++ to preserve line breaks.")
			}
		</script>
		<style>
			.green 		{ font-weight:900; color:green; }
			.blue 		{ color:blue; }
			.scenario	{ padding-bottom:20px; position:relative; }
			.scenarioOutline { position:relative; }
			.testStep 	{ position:relative; cursor:move; }
			.what		{ position:relative; cursor:move; }
			.examples	{ padding-bottom:20px; }
			.edit		{ font-weight:900; color:red; position:absolute; top:0px; left:500px; cursor:pointer; background-image:url('http://icons.iconarchive.com/icons/custom-icon-design/pretty-office-10/16/Pencil-icon.png'); background-repeat:no-repeat; background-position:right top; overflow: visible; width:16px; }
			.delete		{ font-weight:900; color:red; position:absolute; top:0px; left:516px; cursor:pointer; background-image:url('http://icons.iconarchive.com/icons/kyo-tux/delikate/16/Close-icon.png'); background-repeat:no-repeat; background-position:right top; overflow: visible; width:16px; }
			input[type=number] { width:50px; }
			table		{ border-collapse:separate; border-spacing:0px 5px;}
			td			{ border-left: 1px solid black; border-right: 1px solid black; }
			td input	{ border: 0; }
		</style>
	</head>
	<body>
		<div id='featuredef' class='green' style='padding-bottom:20px;'>
			Feature: <input class='green' placeholder="Feature Title" type='text' />
			<br/>
			<textarea class='green' placeholder="Feature Description"></textarea>
		</div>
		<div id='tests'></div>
		<div style="position:fixed;bottom:0px;width:100%;">
			<p style="text-align:center;">
				<button onclick='addScenario()'>Add Scenario</button>
				<button onclick='addScenarioOutline()'>Add Scenario Outline</button>
				<button onclick='download()'>Export as Feature File</button>
			</p>
		</div>
	</body>
</html>